/*
 * Day 12 - ship movement
 */

#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <math.h>

#define INPUT_LEN 750
const char* input[750] = 
{
"W1",
"F91",
"W3",
"F82",
"N1",
"E2",
"N4",
"R90",
"F25",
"N2",
"F75",
"E4",
"R90",
"F91",
"R90",
"F64",
"L90",
"E1",
"L90",
"S2",
"L180",
"S2",
"E3",
"N2",
"E5",
"L90",
"N2",
"R90",
"F30",
"L90",
"N1",
"F37",
"S1",
"E5",
"F3",
"E2",
"F59",
"W3",
"L270",
"S5",
"W5",
"S4",
"F84",
"N5",
"R180",
"E4",
"F31",
"L90",
"E2",
"F77",
"L90",
"N5",
"F17",
"N4",
"N4",
"W2",
"F45",
"S1",
"F92",
"E1",
"F33",
"L270",
"F21",
"L90",
"E1",
"F81",
"N5",
"F20",
"E2",
"R90",
"N4",
"W3",
"L180",
"S2",
"F33",
"E5",
"F87",
"R90",
"N2",
"F29",
"E3",
"S4",
"L90",
"E4",
"R90",
"S2",
"F65",
"L90",
"F69",
"W2",
"N4",
"F73",
"R180",
"S3",
"R90",
"N3",
"R90",
"W1",
"L180",
"F96",
"N3",
"W2",
"L180",
"S5",
"F29",
"E3",
"S4",
"W1",
"F53",
"E1",
"L90",
"E5",
"F26",
"E3",
"R270",
"E2",
"S2",
"W2",
"F43",
"W2",
"F53",
"F74",
"R180",
"N5",
"W3",
"S4",
"F70",
"R90",
"W4",
"F56",
"L90",
"S5",
"R180",
"E4",
"S4",
"F80",
"S1",
"F91",
"R90",
"S4",
"F88",
"L90",
"S5",
"R90",
"E2",
"S1",
"F37",
"N1",
"R90",
"F92",
"W5",
"F14",
"N2",
"E5",
"S2",
"F89",
"L180",
"N4",
"E4",
"L90",
"F32",
"E4",
"R90",
"F99",
"N3",
"L180",
"F78",
"S1",
"R270",
"W1",
"F11",
"S4",
"F47",
"N4",
"L90",
"F17",
"R90",
"E4",
"S3",
"F14",
"S1",
"R90",
"N3",
"F52",
"W3",
"S5",
"L180",
"F41",
"R90",
"F62",
"W1",
"R90",
"E4",
"F1",
"W5",
"F86",
"W1",
"N5",
"F5",
"S1",
"E5",
"F67",
"W3",
"F97",
"E1",
"L90",
"S2",
"E1",
"R90",
"F82",
"E3",
"N2",
"F16",
"L90",
"W2",
"F35",
"R180",
"N2",
"E3",
"N4",
"W4",
"F13",
"S5",
"E1",
"S5",
"L90",
"E5",
"F65",
"E5",
"L90",
"S4",
"E3",
"W4",
"N1",
"R90",
"N5",
"F93",
"R90",
"S5",
"R90",
"L90",
"F86",
"E3",
"F90",
"E4",
"N2",
"E4",
"R180",
"W5",
"R90",
"E3",
"F98",
"F56",
"L90",
"F68",
"L90",
"N3",
"F35",
"S1",
"W5",
"F25",
"L180",
"F7",
"R270",
"F84",
"R90",
"S4",
"E5",
"S3",
"L270",
"F33",
"W3",
"R90",
"W5",
"N3",
"E4",
"R90",
"W2",
"F100",
"E5",
"S2",
"L90",
"F6",
"E1",
"L90",
"S1",
"F17",
"N3",
"E1",
"S3",
"F78",
"R90",
"W5",
"N4",
"L90",
"F13",
"W5",
"R90",
"F7",
"F74",
"R90",
"E4",
"F28",
"L90",
"S5",
"R90",
"F77",
"S2",
"E2",
"N3",
"F30",
"E1",
"R90",
"W2",
"S2",
"F62",
"E2",
"L90",
"E2",
"F56",
"L90",
"F61",
"S1",
"F14",
"W3",
"F23",
"L90",
"E3",
"S3",
"L270",
"S5",
"F97",
"E5",
"S1",
"F96",
"W2",
"F61",
"L180",
"F25",
"L90",
"W4",
"F100",
"W4",
"F14",
"W4",
"S5",
"R90",
"F67",
"E1",
"R90",
"F89",
"W5",
"S3",
"W2",
"N2",
"F64",
"L180",
"S4",
"R270",
"F47",
"E1",
"S1",
"E4",
"N1",
"R90",
"N2",
"E5",
"F97",
"N3",
"E5",
"S5",
"R180",
"E5",
"F34",
"L90",
"W1",
"W1",
"N3",
"R90",
"F17",
"N1",
"F75",
"S4",
"W5",
"N2",
"W1",
"N2",
"L90",
"W3",
"N2",
"F1",
"N1",
"W3",
"R90",
"F18",
"E4",
"N4",
"F18",
"N4",
"F73",
"W4",
"F61",
"W3",
"R90",
"N5",
"L90",
"N4",
"F70",
"E4",
"F10",
"L90",
"F33",
"N5",
"L90",
"W4",
"L180",
"E2",
"F41",
"E1",
"S4",
"E4",
"L90",
"F28",
"N2",
"W4",
"S2",
"F86",
"R180",
"S3",
"W3",
"S3",
"W2",
"F55",
"W1",
"F18",
"W2",
"F18",
"L90",
"S4",
"W1",
"L90",
"F47",
"L90",
"S4",
"F39",
"N5",
"L180",
"S3",
"W5",
"F95",
"W1",
"R90",
"E2",
"N3",
"L90",
"S4",
"F77",
"S1",
"W4",
"S5",
"E4",
"R90",
"W1",
"R90",
"W3",
"W2",
"N4",
"F1",
"W1",
"N5",
"F55",
"E4",
"N4",
"W5",
"L90",
"F90",
"E4",
"R90",
"E2",
"R90",
"S5",
"F44",
"N2",
"E3",
"R90",
"F64",
"W1",
"L180",
"L180",
"F55",
"L90",
"F15",
"S2",
"E1",
"R270",
"F10",
"R90",
"W4",
"F43",
"E1",
"F7",
"N2",
"W3",
"F10",
"N1",
"L270",
"N2",
"L90",
"E2",
"R90",
"F28",
"W2",
"N5",
"F70",
"R90",
"E3",
"E3",
"F75",
"W4",
"L90",
"S2",
"R90",
"F83",
"L270",
"E1",
"F87",
"R180",
"N3",
"L90",
"F30",
"L90",
"E1",
"N5",
"F87",
"N4",
"R90",
"F51",
"W5",
"N3",
"R90",
"S5",
"F98",
"W4",
"N2",
"E2",
"L90",
"E4",
"S1",
"E5",
"F60",
"N1",
"L180",
"E1",
"F10",
"R90",
"W5",
"F90",
"W5",
"F9",
"S1",
"W3",
"F9",
"E2",
"S4",
"L180",
"F61",
"W2",
"N3",
"F35",
"R90",
"E4",
"N3",
"W4",
"L90",
"E1",
"L90",
"S1",
"F62",
"S5",
"W1",
"N5",
"L180",
"F76",
"W3",
"L90",
"W4",
"L90",
"N2",
"E3",
"N5",
"E1",
"N2",
"F13",
"S1",
"F20",
"W5",
"L90",
"S1",
"F89",
"S3",
"L90",
"W2",
"L90",
"F48",
"W5",
"N1",
"R90",
"F93",
"L90",
"E4",
"L90",
"N2",
"F100",
"W5",
"S5",
"W1",
"S1",
"E2",
"S1",
"W4",
"R90",
"S2",
"F99",
"W2",
"F80",
"L90",
"F78",
"N4",
"L90",
"F67",
"S1",
"L90",
"F23",
"W3",
"N1",
"W5",
"F76",
"R270",
"F51",
"L90",
"W2",
"N1",
"E3",
"S3",
"L90",
"F83",
"L90",
"F46",
"S5",
"L180",
"N3",
"E3",
"F49",
"E5",
"N4",
"W5",
"L90",
"E3",
"R90",
"S4",
"F54",
"E1",
"F49",
"N4",
"L180",
"E3",
"L90",
"R90",
"F95",
"W2",
"N2",
"F12",
"R180",
"E4",
"R90",
"N5",
"L180",
"S3",
"W3",
"S1",
"F22",
"W1",
"F18",
"L90",
"F35",
"R90",
"F3",
"S4",
"L90",
"F53",
"W5",
"F58",
"L90",
"S2",
"F48",
"S5",
"R180",
"F67",
"L180",
"W1",
"S3",
"L90",
"F33",
"F34",
"R90",
"F54",
"W2",
"L180",
"S5",
"W4",
"R90",
"F80",
"W4",
"S1",
"W4",
"F35",
"E1",
"F48",
"N3",
"L270",
"F78",
"N4",
"S4",
"F11",
"S1",
"W3",
"L90",
"W1",
"F26",
"R180",
"E3",
"F43",
"S4",
"R180",
"W3",
"N2",
"F80",
"W4",
"F29",
"W5",
"W1",
"R270",
"N3",
"L90",
"F17",
"W4",
"F49",
"S4",
"S1",
"F47"
};

//#define INPUT_LEN 5
const char* testInput[5] = 
{
"F10",
"N3",
"F7",
"R90",
"F11"
};

typedef struct Ship
{
    float x;
    float y;
    float wX; // waypofloat X
    float wY; // waypofloat Y
    //float angle;
} Ship;

static inline float deg2rad(const float deg)
{
    return deg * M_PI / 180.0f;
}

// rotate pofloat oldX, oldY around pofloat pivotX, pivotY
static inline void pointRotation(const float pivotX,
                                 const float pivotY,
                                 const float oldX,
                                 const float oldY,
                                 const float angle,
                                 float* resX,
                                 float* resY)
{
    // translate to the origin
    float x = (float)(oldX - pivotX);
    float y = (float)(oldY - pivotY);

    // rotate
    *resX = (x*cos(deg2rad((float)angle)) - 
             y*sin(deg2rad((float)angle)));
    *resY = (y*cos(deg2rad((float)angle)) +
             x*sin(deg2rad((float)angle)));

    // move back from the origin
    *resX += pivotX;
    *resY += pivotY;
}

// angle is in degrees
static inline void polar2cart(const float radius,
                              const float angle,
                              float* resX,
                              float* resY)
{
   *resX = radius * cos(deg2rad(angle));
   *resY = radius * sin(deg2rad(angle));
}

static void Ship_Init(Ship* ship)
{
    ship->x = 0.0;
    ship->y = 0.0;
    ship->wX = 10.0;
    ship->wY = 1.0;
}

static inline void hNorth(Ship* ship, const float amount)
{
    ship->wY += amount;
}
static inline void hSouth(Ship* ship, const float amount)
{
    ship->wY -= amount;
}
static inline void hEast(Ship* ship, const float amount)
{
    ship->wX += amount;
}
static inline void hWest(Ship* ship, const float amount)
{
    ship->wX -= amount;
}
static inline void hLeft(Ship* ship, const float amount)
{
    float resX;
    float resY;
    pointRotation(ship->x, ship->y, // pivot point
                  (float)(ship->wX + ship->x), 
                  (float)(ship->wY + ship->y), // the pofloat to rotate
                  amount,             // rotation angle
                  &resX, &resY);    // result
    ship->wX = (float)(resX - (float)ship->x);
    ship->wY = (float)(resY - (float)ship->y);
}
static inline void hRight(Ship* ship, const float amount)
{
    float resX;
    float resY;
    pointRotation(ship->x, ship->y, // pivot point
                  (float)(ship->wX + ship->x), 
                  (float)(ship->wY + ship->y), // the pofloat to rotate
                  -amount,            // rotation angle
                  &resX, &resY);      // result
    ship->wX = (float)(resX - (float)ship->x);
    ship->wY = (float)(resY - (float)ship->y);
}
static inline void hForward(Ship* ship, const float amount)
{
    ship->x += amount*ship->wX;
    ship->y += amount*ship->wY;
}

static bool runInstruction(Ship* ship, const char* instr)
{
    int amount;
    char dummy;
    sscanf(instr, "%c%d", &dummy, &amount);
    switch(instr[0])
    {
        case 'N': hNorth(ship, (float)amount); break;
        case 'S': hSouth(ship, (float)amount); break;
        case 'E': hEast(ship, (float)amount); break;
        case 'W': hWest(ship, (float)amount); break;
        case 'L': hLeft(ship, (float)amount); break;
        case 'R': hRight(ship, (float)amount); break;
        case 'F': hForward(ship, (float)amount); break;
        default:
            printf("  ERROR - unhandled inst: %c\n", dummy);
            return false;
    }

    return true;
}

static inline float calcManhattan(const float x, const float y)
{
    return ((x < 0) ? -x : x) + 
           ((y < 0) ? -y : y);
}

int main(void)
{
    size_t i;
    Ship ship;

    Ship_Init(&ship);

    for (i = 0; i < INPUT_LEN; i++)
    {
        if (!runInstruction(&ship, input[i]))
        //if (!runInstruction(&ship, testInput[i]))
        {
            break;
        }
        printf("Inst, x, y, wX, wY: %d, %f, %f, %f, %f\n",
               i, ship.x, ship.y, ship.wX, ship.wY);
    }

    printf("X, Y, Manhattan: %f, %f, %f\n", 
            ship.x, 
            ship.y, 
            calcManhattan(ship.x, ship.y));
    
    return 0;
}

